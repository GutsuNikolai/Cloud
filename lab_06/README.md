# Лабораторная работа №6. Балансирование нагрузки в облаке и авто-масштабирование

## Введение

В данной лабораторной работе была построена отказоустойчивая и автоматически масштабируемая архитектура в AWS, основанная на сервисах **EC2**, **VPC**, **Elastic Load Balancer**, **Auto Scaling Group** и **CloudWatch**.  
Инфраструктура обеспечивает равномерное распределение нагрузки, автоматическое масштабирование при повышении CPU-нагрузки и высокую доступность веб-приложения.

## Цель работы

Цель работы — закрепить практические навыки развертывания облачных архитектур и работы с ключевыми сервисами AWS.  

В ходе выполнения работы были развернуты:
    - VPC с публичными и приватными подсетями;  
    - виртуальная машина с веб-сервером (nginx);  
    - AMI-образ на основе настроенного сервера;  
    - Launch Template для последующего автоскейлинга;  
    - Auto Scaling Group (ASG);  
    - Application Load Balancer (ALB);  
    - нагрузочный тест с использованием CloudWatch Alarms.

## Ход выполнения работы

### Шаг 1. Создание VPC и подсетей

В AWS Console была создана новая виртуальная сеть (VPC) с использованием мастер-настройки (VPC Wizard).  
Мастер автоматически создает:
    - базовый CIDR-блок VPC,
    - публичные и приватные подсети,
    - таблицы маршрутов,
    - Internet Gateway.

Мастер-настройки все неплохо настроил сам, поэтому вручную ничего переделывать не пришлось. Шаги по созданию подсетей, routing tables, igw были пропущены.

Таким образом была создана корректная сетевой архитектура AWS, включающая VPC, публичные и приватные подсети, Internet Gateway и таблицы маршрутов.  
Данная структура служит фундаментом для развертывания веб-сервера, балансировщика нагрузки и Auto Scaling Group.

### Шаг 2. Создание и настройка виртуальной машины

Для подготовки базового веб-сервера был развернут EC2-инстанс (`Amazon Linux 2, t3.micro`) в публичной подсети созданной VPC.  
Инстансу автоматически назначен публичный IP, что позволило подключаться к нему извне.

Была создана отдельная Security Group со следующими правилами:
    - `SSH (22)` — доступ только с моего IP;
    - `HTTP (80)` — открыт для всех (0.0.0.0/0).
    - Весь исходящий трафик открыт

Через User Data добавлен установочный скрипт, который автоматически выполнил обновление системы, установку и запуск `nginx`, а также разместил простой тестовый `index.html`.  

Был включён `Detailed Monitoring` для сбора метрик в `CloudWatch`.

После запуска инстанс успешно прошёл проверки статуса и корректно отдавал веб-страницу по своему публичному IP.
Более тут особо описывать нечего, так как это рунный процесс пока что.

[ec2_test](images/image_1_webaccess.png)

### Шаг 3. Создание AMI

После настройки веб-сервера был создан собственный AMI-образ EC2-инстанса.
Этот образ используется Auto Scaling Group для автоматического запуска новых идентичных серверов.

[ami](images/ami.png)

### Шаг 4. Создание Launch Template

На основе созданного AMI был настроен `Launch Template`, в котором указаны:
    - выбранный instance type (t3.micro),
    - приватные подсети для размещения инстансов,
    - Security Group,
    - переданный AMI-образ.

Этот шаблон используется `Auto Scaling Group` для автоматического создания новых EC2-инстансов.

### Шаг 5. Создание Target Group

Была создана `Target Group (HTTP, порт 80)`, в которую `Auto Scaling Group` автоматически регистрирует все свои инстансы.  
Это позволяет `Load Balancer` определять состояние серверов и направлять трафик только на здоровые экземпляры.

### Шаг 6. Создание Application Load Balancer

Был создан `Application Load Balancer` (ALB) в двух публичных подсетях.  
Он принимает входящий HTTP-трафик и распределяет его между инстансами ASG.  

ALB был привязан к `Target Group`, в которой автоматически регистрируются инстансы `Auto Scaling Group`.  
Проверки работоспособности (Health Checks) выполняются через HTTP на порт 80.

После настройки ALB успешно отдавал страницу веб-приложения по своему DNS-имени.

[resource_map](images/resource_map.png)

### Шаг 7. Создание Auto Scaling Group (ASG)

На основе созданного Launch Template была настроена `Auto Scaling Group (ASG).  
ASG была размещена в приватных подсетях, чтобы инстансы не имели прямого доступа из интернета и обслуживались только через Load Balancer.

1. Основные параметры ASG:
    - **Min capacity:** 2
    - **Desired capacity:** 2  
    - **Max capacity:** 4  
Эти значения позволяют системе автоматически запускать дополнительные инстансы при росте нагрузки и сокращать их количество при снижении.

2. Интеграция с Target Group
    ASG была связана с созданной Target Group, благодаря чему все запущенные инстансы автоматически регистрируются в ней и проходят Health Checks.

3. Поведение ASG

ASG следит за состоянием инстансов и:
    - перезапускает их при сбоях
    - масштабирует количество EC2 вверх или вниз согласно политике масштабирования
    - поддерживает желаемый уровень доступности приложения

Таким образом, ASG обеспечивает автоматическое восстановление и масштабирование серверов без вмешательства пользователя.

### Шаг 8. Тестирование работы Application Load Balancer

Для проверки корректной работы `Application Load Balance`r` был использован его публичный DNS-адрес.  
При обращении к ALB запросы распределялись между инстансами `Auto Scaling Group`, что подтверждало успешную натсройку и работу Load Balancer.
При разных запросах страницы имели разные ip адреса - брались адреса разных работающих инстансов, что также доказывает корретную настройку всех компонентов.

[Load_balancer](images/load_balancer_page.png)

### Шаг 9. Нагрузочное тестирование и проверка Auto Scaling

Для проверки реакции `Auto Scaling Group` на высокую нагрузку был использован специальный тестовый маршрут веб-приложения: `/load?seconds=60`
При обращении к этому URL сервер выполняет интенсивные вычисления в течение указанного времени, что приводит к значительному росту CPU-нагрузки.

1. Рост нагрузки

    Во время теста загрузка процессора достигала ~95–98, что корректно фиксировалось в `CloudWatch Metrics`.
    Это позволило проверить работу созданного `CloudWatch Alarm` и политик масштабирования.

    [CPU_load](images/alarm_check.png)

2. Реакция Auto Scaling Group

    После превышения порога CPU (trigger condition), ASG инициировала запуск дополнительного EC2-инстанса.  
    Новый инстанс был автоматически:
    - развёрнут из AMI
    - зарегистрирован в Target Group
    - прошёл health checks
    - начал обслуживать трафик через Load Balancer

    [auto_balansing](images/load_balansing_additional_instances.png)

3. Alarms
    После достижения CPU нагрузки 50% в CloudWatch появилось уведомление о новом alarm со статусом `In alarm`, что сигнализирует о корректной работе CloudWatch и систем мониторинга

    [active_alarm](images/ALARM_SHNELEA_SHNELEA.png)

## Вывод

В ходе лабораторной работы была развернута полноценная отказоустойчивая архитектура в AWS, включающая VPC, приватные и публичные подсети, `Target Group`, `Application Load Balancer` и `Auto Scaling Group`.  
Система успешно продемонстрировала автоматическое масштабирование при росте нагрузки и корректное распределение трафика между инстансами.

Все компоненты — от веб-сервера и AMI до `Load Balancer` и `CloudWatch Alarm` — работали согласованно, обеспечивая стабильную и гибкую инфраструктуру.  
Полученный результат подтверждает правильную настройку сетевой среды, политик масштабирования и балансировки нагрузки.

## Ответы на контрольные вопросы

1. Что такое `image` и чем он отличается от `snapshot`? Какие есть варианты использования `AMI`?
    Image (AMI) — образ для запуска EC2; Snapshot — копия диска. AMI включает snapshot + настройки запуска.
    Запуск новых EC2, авто-масштабирование, создание одинаковых серверов, бэкапы.
`
2. Что такое `Launch Template` и зачем он нужен? Чем он отличается от `Launch Configuration`?
    Шаблон параметров для запуска EC2, используемый ASG. Современнее Launch Configuration.
    Launch Template поддерживает версии и больше настроек; Launch Configuration устарел.

3. Зачем необходим и какую роль выполняет `Target Group`?
    Принимает трафик от Load Balancer и направляет его на здоровые инстансы.

4. В чем разница между `Internet-facing` и Internal?
    Internet-facing доступен из интернета; Internal работает только внутри VPC.

5. Что такое `Default action` и какие есть типы `Default action`?
    Действие LB, если правила не совпали: `forward`, `redirect` или `fixed response`.

6. Почему для `Auto Scaling Group` выбираются приватные подсети?
    Для безопасности — прямой доступ невозможен, трафик идёт только через `Load Balancer`.

7. Зачем нужна настройка: `Availability Zone distribution`?
    Чтобы инстансы распределялись по AZ - это повышает отказоустойчивость.

8. Что такое `Instance warm-up period` и зачем он нужен?
    Обнаруживает высокий CPU usage и автоматически запускает новый EC2, после чего добавляет его в Target Group.

9. Почему при обновлении страницы `Load Balancer` видны разные адреса?
    Load Balancer выбирает разные инстансы, которые здоровы и могут принять запрос. Поэтому мы просто видим ip разных инстансов.

10. Была дана нагрузка на CPU, пришел аларм, количество инстансов увеличилось. Какую роль в этом сыграл `Auto Scaling`?
    Auto Scaling при облнаружении высокой нагрузки автоматически запускает новый инстанс и добавляет его в `Target Group`, чтоб он разделил нагрузку.
